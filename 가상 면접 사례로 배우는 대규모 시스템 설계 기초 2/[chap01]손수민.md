# Chap 1. 근접성 서비스

---

### 1단계: 문제 이해 및 설계 범위 확정

**기능 요구사항**
- 사용자의 위치(경도와 위도 쌍)와 검색 반경 정보에 매치되는 사업장 목록을 반환
- 사업장 소유주가 사업장 정보를 추가/삭제/갱신할 수 있도록 하되, 그 정보가 검색 결과에 실시간으로 반영될 필요는 없다고 가정
- 고객은 사업장의 상세 정보를 살필 수 있어야 함

**비기능 요구사항**
- 낮은 응답 지연
- 데이터 보호
- 고가용성

### 2단계: 개략적 설계안 제시 및 동의 구하기

**개략적 설계**

- 위치 기반 서비스(LBS)와 사업장 서비스 두 부분으로 구성된다.
- LBS는 사본 데이터베이스를 읽고, 사업장 서비스는 주 데이터베이스에 쓰기를 수행한다.

**주변 사업장 검색 알고리즘**

방안 1: 2차원 검색
```SQL
SELECT business_id, latitude, longitude,
FROM business
WHERE (latitude BETWEEN {:my_lat} - radius AND {:my_lat} + radius)
AND
  (longitude BETWEEN {:my_long} - radius AND {:my_long} + radius)
```
- 이 방법은 전체 컬럼을 읽어야 하여 양이 많다.

-> 지리적 정보에 색인을 만드는 알고리즘
- 해시 기반 방안: 균등 격자(even grid), 지오해시(geohash), 카르테시안 계층(cartesian tiers) 등
- 트리 기반 방안: 쿼드트리(quadtree), 구글 S2, R 트리 등

위 구현 방법들의 개략적 아이디어는 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만드는 것이다.

방안 2: 균등 격자
- 작은 격자 또는 구획으로 나누는 단순한 접근법
- 사업장 분포가 균등하지 않다. -> 인구 밀집 지역에는 작은 격자를, 그렇지 않은 지역에는 큰 격자 사용하면 좋을 듯

방안 3: 지오해시(Geohash)
- 2차원의 위도 경도 데이터를 1차원의 문자열로 반환
- 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해 나간다.
- 격자 가장자리 관련 이슈

방안 4: 쿼드트리(quadtree)
- 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할하는 데 흔히 사용되는 자료 구조다.
- 쿼드트리 구축 시간과 서버 시작 시간이 오래 걸림
- 사업장 정보를 데이터베이스에서 동시에 읽으면 시스템 부하가 큼
- 수 많은 키가 한 번에 무효화되어 캐시 서버에 막대한 부하가 가해질 수 있음

방안 5: 구글 S2
- 구글 S2 기하(geometry) 라이브러리는 메모리 기반(in-memory)
- 힐베르트 곡선이라는 space-filling curve를 사용하는데, 곡선 상에서 인접한 두 지점이 1차원 공간 내에서도 인접한 위치에 두도록 함

### 3단계: 상세 설계

**지역 및 가용성 구간**

- 사용자와 시스템 사이의 물리적 거리를 최소한으로 줄일 수 있다.
- 트래픽을 인구에 따라 고르게 분산하는 유연성을 확보할 수 있다.
- 그 지역의 사생활 보호법에 맞는 우녕이 가능하다.

새로 추가하거나 갱신한 정보는 다음날 반영된다는 것을 사업장과 합의하여, 캐시에 보관된 정보 갱신은 밤에 작업을 돌려서 처리할 수 있다.

### 4단계: 마무리

색인 방안 정리

- 2차원 검색
- 균등 분할 격자
- 지오해시
- 쿼드트리
- 구글 S2