# Chap 5. swap, 메모리 증설의 포인트

### 5.1 swap 영역

- 물리 메모리가 부족할 경우를 대비해서 만들어 놓은 영역
- 디스크의 일부분을 메모리처럼 사용
- 메모리에 비해 접근과 처리 속도가 현저하게 떨어져 성능 저하 발생

```Shell
free -k
```

전체 swap 영역의 크기, 현재 사용 중인 swap 영역의 크기, 현재 남아있는 swap 영역의 크기가 표시된다.

/proc/<pid>/smaps 파일은 메모리 정보를 저장하고 있어, swap 사용 여부, 메모리 누수 등을 확인할 수있다.

/proc/<pid>/status: 특정 프로세스의 전반적인 상태 정보를 요약하여 제공한다. 전체 swap 영역 에 대한 정보가 있다.

```Shell
smem -t
```

smem 유틸리티는 /proc/<pid> 의 내용을 바탕으로 각 프로세스들의 메모리 사용 현황을 보여준다.

### 5.2 버디 시스템

커널은 버디 시스템을 통해서 프로세스에 메모리 할당. 버디 시스템은 물리 메모리를 연속된 메모리 영역을 관리한다.

```Shell
cat /proc/buddyinfo
```

### 5.3 메모리 재할당 과정

1. 커널이 사용하는 캐시 메모리의 재할당
2. swap을 사용하는 재할당 - 성능 저하

### 5.4 vm.swappiness와 vm.vfs_cache_pressure

vm.swappiness: 커널이 얼마나 공격적으로 메모리 영역을 swap 영역으로 옮기느냐를 결정하는 파라미터이며, 기본값은 60이다.
- 메모리가 부족한 상황에서 캐시를 비우느냐 아니면 특정 프로세스의 메모리 영역을 swap 영역으로 옮기느냐를 결정한다.
- 커널이 메모리를 재할당할 때 캐시 메모리를 재할당할 것인지 아니면 swap을 사용할 것인지의 비율을 조절할 수 있다.

vm.vfs_cache_pressure: 커널이 메모리를 재할당할 때 디텔터리나 inode에 대한 캐시를 재할당하려는 경항을 조절한다.

### 5.5 메모리 증설의 포인트

메모리 누수와 많은 메모리를 필요로 하는 것인지 아는 방법
1. 메모리의 사용량이 선형적으로 증가하는 경우
    - 메모리 누수 의심: 요청을 처리하기 위해 메모리를 할당 받고 요청이 끝나면 메모리가 해제해야 하는데 늘어남
2. 메모리의 사용량이 폭증하는 경우
    - 순간적으로 요청이 증가하며 메로리의 사용량이 폭증함.
    - 사용한 메모리의 최대치를 계산해서 메모리를 증설
    - 서비스에 영향을 끼칠 응답 속도가 아니라면 swap을 사용

### 5.6 Case Study - gdb를 이용해서 메모리 누수 잡기

```Shell
pmap
```

gdb를 통해 메모리 덤프를 생성하고 실제 메모리의 내용을 살펴보면 메모리 누수를 확인할 수 있다.
