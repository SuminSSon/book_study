# Chap 6. NUMA, 메모리 관리의 새로운 세계

### 6.1 NUMA 아키텍처

NUMA(Non-Uniform Memory Access): 멀티 프로세서 환경에서 적용되는 메모리 접근 방식
- 로컬 메모리로의 접근이 동시에 이뤄질 수 있다는 것
- 각 노드에는 CPU와 메모리가 한 세트로 할당되어 있으며 성능상 같은 노드에 위치한 메모리에 접근하는 것이 가장 좋다. 이를 메모리의 지역성을 높인다고 표현한다.

### 6.2 리눅스에서의 NUMA 확인

```Shell
numactl --show
```

numactl: NUMA와 관련된 정책을 확인하거나 설정할 때 사용하는 명령어

NUMA와 관련된 메모리 할당 정책
1. default 정책: 현재 프로세스가 실행되고 있는 프로세서가 포함된 노드에서 먼저 메모리를 할당 받아 사용
2. bind 정책: 특정 프로세스를 특정 노드에 바인딩시키는 방식
3. preferred 정책: 선호하는 노드 설정. bind가 반드시 설정한 노드에서 메모리를 할당 받는 반면에 preferred는 가능한 한 설정한 노드로부터 메모리 할당 받음
4. interleaved 정책: 다수의 노드에서 거의 동일한 비율로 메모리를 할당 받음. RR 정책

free 영역이 많아도 메모리 할당 정책에 따라 불규칙하게 메모리 할당이 일어나면 swap을 사용하여 성능이 저하됨. ```numastat```을 통하여 확인 가능.

```Shell
proc/<pid>/numa_maps
```

현재 동작 중인 프로세스의 메모리 할당 정책과 관련된 정보 기록

### 6.3 메모리 할당 정책별 특징

리눅스 스케줄러는 가능한 한 기존에 바인딩된 노드에 계속 바인딩하려는 경향이 있음

정책의 동작을 이해하고, 운영하려는 시스템의 워크로드가 어떤 방식으로 동작하는 지를 알아야 성능을 최적화할 수 있다.

### 6.4 numad를 이용한 메모리 할당 관리

numad: 하나의 프로세스가 필요로 하는 메모리를 하나의 노드에서만 할당 받을 수 있도록 설정할 수 있기 때문에 메모리의 지역성을 높이고 성능을 최적화할 수 있다.
- 지역성을 너무 높이면 메모리 불균형이 발생할 수 있다.
- 백그라운드 데몬과 같은 형태로, 시스템에 상주하면서 프로세스들의 메모리 사용 현황을 주기적으로 모니터링하며 최적화하는 작업을 담당한다.

### 6.5 vm.zone_reclaim_mode 커널 파라미터

zone: /proc/buddyinfo로 메모리 zone 확인 가능
- DMA, DMA32 zone

vm.zone_reclaim_mode은 어떤 zone에 대한 재할당 여부를 지정할 수 있다.
- 분리된 zone들 간에 특정 영역의 메모리가 부족할 경우 다른 zone의 메모리를 할당할 수 있도록 하는 옵션을 제공하는 파라미터
- 0 (False)은 zone 안에서 재할당을 하지 않겠다는 의미
- 1 (True)은 zone 안에서 재할당을 하겠다는 뜻으로 메모리가 부족할 경우 zone 내부적으로 재할당을 진행하고, 그래도 부족하다면 다른 zone에서 재할당을 받겠다는 의미

### 6.6 NUMA 아키텍처의 메모리 할당 정책과 워크로드

NUMA 시스템에서 워크로드를 확인하는 방법
- 사용할 메모리의 크기와 프로세스의 스레드 개수

| 스레드 개수 | 메모리의 크기 |
| - | - |
| 싱글 스레드 | 메모리가 노드 하나 크기를 넘지 않음 |
| 멀티 스레드 | 메모리가 노드 하나 크기를 넘지 않음 |
| 싱글 스레드 | 메모리가 노드 하나 크기를 넘음 |
| 멀티 스레드 | 메모리가 노드 하나 크기를 넘음 |


1. 이런 경우는 거의 없음. 이런 경우는 1소켓의 UMA 아키텍처를 사용해야 함.
2. 메모리 할당을 한 곳에서 이뤄지면 되어 cpunodebind 모드를 통해 여러 개의 코어에 프로세스를 바인딩 시키고 해당 노드에서만 메모리를 할당 받아서 사용하게 하면 성능이 가장 좋다.
3. 메모리 지역성을 높여야 한다. 싱글 스레드로 동작하면 리모트 액세스가 발생한다. 리모트 액세스를 최소화하기 위해 동일한 CPU에 계속 바인딩이 되어야 한다. cpunodebind를 사용하고 vm.zone_reclaim_mode의 값은 0으로 하는 것이 성능에 유리하다.
4. 가장 많이 사용되는 경우이다.interleave 모드가 최적의 성능을 낼 수 있고, vm.zone_reclaim_mode은 0으로 지정해야 유리하다.